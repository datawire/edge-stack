#!/usr/bin/make -f

aes_dir := $(patsubst %/,%,$(dir $(lastword $(MAKEFILE_LIST))))

all: $(aes_dir)/config.yml
.PHONY: all

$(aes_dir)/yq: $(aes_dir)/yq.d/go.mod
	cd $(<D) && go build -o $(abspath $@) github.com/mikefarah/yq/v3

$(aes_dir)/config.yml: $(aes_dir)/yq $(MAKEFILE_LIST) $(aes_dir)/config.yml.d $(sort $(wildcard $(aes_dir)/config.yml.d/*.yml))
	{ echo '# Generated by `./generate`. DO NOT EDIT.'; echo; $(<D)/$(<F) merge $(filter %.yml,$^); } > $@
