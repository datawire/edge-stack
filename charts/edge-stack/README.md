# AES

[Edge Stack](https://github.com/datawire/ambassador) - The Ambassador Edge Stack is a self-service, comprehensive edge stack that is Kubernetes-native and built on [Envoy Proxy](https://www.envoyproxy.io/).

## TL;DR;

```console
$ helm repo add edge-stack https://s3.amazonaws.com/datawire-static-files/charts
$ helm repo update
$ helm install edge-stack --devel edge-stack/edge-stack -n ambassador
```

## Introduction

This chart deploys Edge Stack on a [Kubernetes](http://kubernetes.io) cluster using the [Helm](https://helm.sh) package manager.
This chart will install version 2.1 of Edge Stack. All future charts for the Edge Stack 2.X release line can be found here.

Versions in the 1.X release line of Edge Stack and Emissary Ingress share a single chart that can be found in the [Emissary-Ingress repository here](https://github.com/emissary-ingress/emissary/tree/release/v1.14/charts/ambassador) under the branch for the specific release.
Eg branch `release/v1.14` for the latest 1.14 chart, `release/v1.13` for 1.13 and so on.

> Note that for 1.0 releases in the chart that can be found in the Emissary-Ingress repository, the `enableAES` helm value is used to control installing Edge-Stack or Emissary-Ingress.

As of version 2.0, Emissary-Ingress and Ambassador Edge Stack have separate charts. The helm chart for Emissary-ingress 2.X can be found in the `master` branch of the Emissary-Ingress repository linked above, and the chart for Ambassador Edge Stack 2.X lives in this repository.


## Prerequisites

- Kubernetes v1.11+

## Helm Values

This helm chart inherits much of the config from the [Emissary-Ingress 2.X Helm Chart](https://github.com/emissary-ingress/emissary/tree/master/charts/emissary-ingress).
Because of this, any value that you do not see in the default `values.yaml` file here specifically for the Edge Stack installation must be configured under the `emissary-ingress` value.
For example, if you would like to set the `createDefaultListeners` you would enable that setting in a values file like so for the Edge Stack chart:

```
emissary-ingress:
  createDefaultListeners: true
```

If you were installing Emissary-ingress instead, using its chart, you would not need the top level `emissary-ingress` value.

```
createDefaultListeners: true
```

All the helm values that this chart inherits from the Emissary-ingress chart [can be found here](https://github.com/emissary-ingress/emissary/tree/master/charts/emissary-ingress).
If a value is specific to Edge Stack it can be found in this chart, otherwise for all values applicable to both Emissary-ingress and Edge Stack are inherited from the Emissary-ingress chart.

## Installing the Chart

To install the chart with the release name `edge-stack`:

```console
$ helm install edge-stack --devel edge-stack/edge-stack -n ambassador
```

The command deploys Edge Stack on the Kubernetes cluster in the default configuration. The [configuration](#configuration) section lists the parameters that can be configured during installation.

> **Tip**: List all releases using `helm list`

## Uninstalling the Chart

To uninstall/delete the `edge-stack`:

```console
$ helm delete edge-stack -n ambassador
```

The command removes all the Kubernetes components associated with the chart and deletes the release.

## Changelog

Notable chart changes are listed in the [CHANGELOG](./CHANGELOG.md)

## Configuration

The following table lists the configurable parameters of the `edge-stack` chart and their default values.

|              Parameter              |                                                                                                                                                                    Description                                                                                                                                                                     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Default                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|-------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| nameOverride                        | Manually set metadata for the Release. Defaults to .Chart.Name                                                                                                                                                                                                                                                                                     | `edge-stack`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| fullnameOverride                    | Defaults to .Release.Name-.Chart.Name unless .Release.Name contains "ambassador"                                                                                                                                                                                                                                                                   | `''`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| namespaceOverride                   | Defaults to .Release.Namespace                                                                                                                                                                                                                                                                                                                     | `''`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| emissary-ingress                    | Emissary Chart Values. all values under emissary-ingress key are passed to [the emissary chart](https://github.com/emissary-ingress/emissary/blob/master/charts/emissary-ingress/README.md) <br> Example: <br> `setting `emissary-ingress.service.type=NodePort` will pass `service.type=NodePort` to the underlying emissary chart`               | `{"envRaw":"- name: REDIS_URL\n  {{- if .Values.redisURL }}\n  value: {{ .Values.redisURL }}\n  {{- else }}\n  value: {{ include \"ambassador.fullname\" . }}-redis:6379\n  {{- end }}\n{{- if and .Values.licenseKey.secretName }}\n- name: AMBASSADOR_AES_SECRET_NAME\n  value: {{ .Values.licenseKey.secretName }}\n{{- end }}\n","image":{"pullPolicy":"IfNotPresent","repository":"docker.io/datawire/aes","tag":"2.1.0"},"licenseKey":{"createSecret":true},"nameOverride":"edge-stack","service":{"ports":[{"name":"http","port":80,"targetPort":8080},{"name":"https","port":443,"targetPort":8443}],"type":"LoadBalancer"},"serviceAccount":{"create":true},"singleNamespace":false,"test":{"enabled":false},"volumeMountsRaw":"{{- if and .Values.licenseKey.createSecret }}\n- name: {{ include \"ambassador.fullname\" . }}-secrets\n  mountPath: /.config/ambassador\n  readOnly: true\n{{- end }}\n","volumesRaw":"- name: {{ include \"ambassador.fullname\" . }}-secrets\n  secret:\n    {{- if and .Values.licenseKey .Values.licenseKey.secretName }}\n    secretName: {{ .Values.licenseKey.secretName }}\n    {{- else }}\n    secretName: {{ include \"ambassador.fullname\" . }}\n    {{- end }}\n"}` |
| rbac.create                         | Specifies whether RBAC resources should be created                                                                                                                                                                                                                                                                                                 | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| rbac.podSecurityPolicies            | List of Pod Security Policies to use on the container. If security.podSecurityPolicy is set, it will be appended to the list                                                                                                                                                                                                                       | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| rbac.nameOverride                   | Name of the RBAC resources defaults to the name of the release. Set nameOverride when installing Ambassador with cluster-wide scope in different namespaces with the same release name to avoid conflicts.                                                                                                                                         | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| global.rbac.create                  | Specifies whether RBAC resources should be created                                                                                                                                                                                                                                                                                                 | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| global.rbac.podSecurityPolicies     | List of Pod Security Policies to use on the container. If security.podSecurityPolicy is set, it will be appended to the list                                                                                                                                                                                                                       | `[]`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| global.rbac.nameOverride            | Name of the RBAC resources defaults to the name of the release. Set nameOverride when installing Ambassador with cluster-wide scope in different namespaces with the same release name to avoid conflicts.                                                                                                                                         | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| global.crds.enabled                 |                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| global.crds.create                  |                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| global.crds.keep                    |                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| licenseKey.value                    |                                                                                                                                                                                                                                                                                                                                                    | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| licenseKey.createSecret             |                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| licenseKey.secretName               |                                                                                                                                                                                                                                                                                                                                                    | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| licenseKey.annotations              | Annotations to attach to the license-key-secret.                                                                                                                                                                                                                                                                                                   | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| createDevPortalMappings             | The DevPortal is exposed at /docs/ endpoint in the AES container. Setting this to true will automatically create routes for the DevPortal.                                                                                                                                                                                                         | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| devportal.docsPrefix                |                                                                                                                                                                                                                                                                                                                                                    | `/documentation/`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| redisURL                            | The Ambassador Edge Stack uses a redis instance for managing authentication, rate limiting, and sharing minor configuration details between pods for centralized management. These values configure the redis instance that ships by default with The Ambassador Edge Stack. URL of your redis instance. Defaults to redis instance created below. | ``                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| redis.create                        |                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| redis.image.repository              |                                                                                                                                                                                                                                                                                                                                                    | `redis`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| redis.image.tag                     |                                                                                                                                                                                                                                                                                                                                                    | `5.0.1`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| redis.image.pullPolicy              |                                                                                                                                                                                                                                                                                                                                                    | `IfNotPresent`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| redis.annotations.deployment        |                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| redis.annotations.service           |                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| redis.resources                     |                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| redis.nodeSelector                  | If you want to specify resources, uncomment the following lines and remove the curly braces after 'resources:'. These are placeholder values and must be tuned. limits: cpu: 100m memory: 256Mi requests: cpu: 50m memory: 128Mi                                                                                                                   | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| redis.affinity                      |                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| redis.tolerations                   |                                                                                                                                                                                                                                                                                                                                                    | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| authService.deploymentExtraName     |                                                                                                                                                                                                                                                                                                                                                    | `auth`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| authService.create                  |                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| authService.optional_configurations | Set additional configuration options. See https://www.getambassador.io/reference/services/auth-service for more information                                                                                                                                                                                                                        | `{}`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| rateLimit.create                    |                                                                                                                                                                                                                                                                                                                                                    | `true`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| rateLimit.deploymentExtraName       |                                                                                                                                                                                                                                                                                                                                                    | `ratelimit`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| deploymentTool                      |                                                                                                                                                                                                                                                                                                                                                    | `''`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| enableTestService                   |                                                                                                                                                                                                                                                                                                                                                    | `false`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |


Specify each parameter using the `--set key=value[,key=value]` argument to `helm install`. For example:

```console
$ helm install edge-stack --devel edge-stack/edge-stack -n ambassador --set nameOverride=edge-stack
```

Alternatively, a YAML file that specifies the values for the parameters can be provided while
installing the chart. For example:

```console
$ helm install edge-stack --devel edge-stack/edge-stack -n ambassador --values values.yaml
```
